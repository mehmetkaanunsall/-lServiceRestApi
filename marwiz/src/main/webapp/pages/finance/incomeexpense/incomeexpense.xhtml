<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">


    <p:panelGrid id="grdIncomeExpense" columns="2" layout="grid" class="panelGridNoBorder">

        <h:panelGroup id="pnlIncome">

            <ui:include src="/pages/general/common/treetabletoolbar.xhtml" >
                <ui:param name="bean" value="#{incomeBean}"/> 
                <ui:param name="update" value="dlgIncomeExpense"/>
                <ui:param name="btnNewId" value="#{incomeBean.getRendered(158, 0)}"/>
                <ui:param name="datatable" value="frmIncome:dtbIncome" /> 
                <ui:param name="dtbWidgetVar" value="incomePF" /> 
                <ui:param name="renderedFilter" value='false'/>
                <ui:param name="renderedToggler" value='false'/>
                <ui:param name="renderedExel" value='false'/>
                <ui:param name="renderedPdf" value='false'/>
                <ui:param name="renderedExpanded" value="true"/>
                <ui:param name="form" value="frmIncomeToolbar"/>
                <ui:param name="fileName" value="#{loc.incomelist}"/> 

            </ui:include>

            <h:form id="frmIncome">

                <p:treeTable id="dtbIncome"  class="treeBankAndBranch" widgetVar="incomePF" emptyMessage="#{loc.norecordsfound}"  value="#{incomeBean.root}"  var="Income" selectionMode="single" selection="#{incomeBean.selectedIncomeExpense}" >    

                    <p:ajax event="select" listener="#{incomeBean.update()}"  resetValues="true" update="dlgIncomeExpense" global="false"/>

                    <p:column id="clmName"  headerText="#{loc.incomename}" sortable="true" sortBy="#{Income.name}">
                        <p:commandLink rendered="#{Income.parentId.id==0 and incomeBean.getRendered(158, 0)}" class="Fleft" action="#{incomeBean.createChild()}" title="#{loc.add}" process="@this" resetValues="true" update="dlgIncomeExpense"> 
                            <i class="fa fa-plus Fs15 " />
                            <f:setPropertyActionListener value="#{Income}" target="#{incomeBean.selectedParent}"/>
                        </p:commandLink>
                        <h:outputText value="#{Income.name}" class="#{Income.parentId.id!=0 ? 'MarLeft20' : ''}" />
                    </p:column>
                    <p:column id="clmBalance" headerText="#{loc.balance}" sortable="true" sortBy="#{Income.balance}" >
                        <h:outputText value="#{Income.balance}" class="Fright">
                            <f:converter converterId="currencyConverter" />
                            <f:attribute name="type" value="currency" />
                            <f:attribute name="currency" value="#{sessionBean.user.lastBranch.currency}" />
                        </h:outputText>
                    </p:column>
                    <p:column id="clmIsProfitMarginReport" class="TexAlCenter"  headerText="#{loc.reflecttoprofitlossreport}" sortable="true" sortBy="#{Income.isProfitMarginReport}">
                        <h:outputText value="#{Income.isProfitMarginReport ? loc.yes : loc.no}" />
                    </p:column>


                </p:treeTable>
            </h:form>

        </h:panelGroup>
        <h:panelGroup id="pnlExpense">

            <ui:include src="/pages/general/common/treetabletoolbar.xhtml" >
                <ui:param name="bean" value="#{expenseBean}"/> 
                <ui:param name="update" value="dlgIncomeExpense"/>
                <ui:param name="btnNewId" value="#{expenseBean.getRendered(158, 0)}"/>
                <ui:param name="datatable" value="frmExpense:dtbExpense" /> 
                <ui:param name="dtbWidgetVar" value="expensePF" /> 
                <ui:param name="renderedFilter" value='false'/>
                <ui:param name="renderedToggler" value='false'/>
                <ui:param name="renderedExel" value='false'/>
                <ui:param name="renderedPdf" value='false'/>
                <ui:param name="renderedExpanded" value="true"/>
                <ui:param name="form" value="frmExpenseToolbar"/>
                <ui:param name="fileName" value="#{loc.expenselist}"/> 

            </ui:include>


            <h:form id="frmExpense">

                <p:treeTable id="dtbExpense"  class="treeBankAndBranch" widgetVar="expensePF" emptyMessage="#{loc.norecordsfound}" value="#{expenseBean.root}"  var="Expense" selectionMode="single" selection="#{expenseBean.selectedIncomeExpense}" >    

                    <p:ajax event="select" listener="#{expenseBean.update()}"  resetValues="true" update="dlgIncomeExpense" global="false"/>

                    <p:column id="clmName"  headerText="#{loc.expensename}" sortable="true" sortBy="#{Expense.name}">
                        <p:commandLink class="Fleft" rendered="#{Expense.parentId.id==0 and expenseBean.getRendered(158, 0)}" action="#{expenseBean.createChild()}" title="#{loc.add}" process="@this" resetValues="true" update="dlgIncomeExpense"> 
                            <i class="fa fa-plus Fs15 " />
                            <f:setPropertyActionListener value="#{Expense}" target="#{expenseBean.selectedParent}"/>
                        </p:commandLink>
                        <h:outputText value="#{Expense.name}" class="#{Expense.parentId.id!=0 ? 'MarLeft20' : ''}" />
                    </p:column>
                    <p:column id="clmBalance" headerText="#{loc.balance}" sortable="true" sortBy="#{Expense.balance}" >
                        <h:outputText value="#{Expense.balance}" class="Fright">
                            <f:converter converterId="currencyConverter" />
                            <f:attribute name="type" value="currency" />
                            <f:attribute name="currency" value="#{sessionBean.user.lastBranch.currency}" />
                        </h:outputText>
                    </p:column>
                    <p:column id="clmIsProfitMarginReport" class="TexAlCenter"  headerText="#{loc.reflecttoprofitlossreport}" sortable="true" sortBy="#{Expense.isProfitMarginReport}">
                        <h:outputText value="#{Expense.isProfitMarginReport ? loc.yes : loc.no}" />
                    </p:column>


                </p:treeTable>
                <p:remoteCommand name="goToRelatedRecord" actionListener="#{incomeExpenseMovementTabBean.goToRelatedRecord()}" delay="200"/>
            </h:form>


        </h:panelGroup>
    </p:panelGrid>


    <p:dialog  id="dlgIncomeExpense" widgetVar="dlg_IncomeExpense" transient="true" width="#{incomeExpenseProcessBean.processType==1 or incomeExpenseProcessBean.processType==3 or (incomeExpenseProcessBean.processType==2 and incomeExpenseProcessBean.selectedObject.parentId.id==0) ? '40%' : '50%'}" resizable="false" focus="dlgIncomeExpense" dynamic="true"  responsive="true" closeOnEscape="true" modal="true">            
        <h:form id="frmNewIncomeExpense">  
            <ui:include src="/pages/general/common/processtoolbar.xhtml" >
                <ui:param name="bean" value='#{incomeExpenseProcessBean}' />
                <ui:param name="outputtext" value="#{incomeExpenseProcessBean.selectedObject.isIncome ? loc.incomeprocesses : loc.expenseprocesses}"/>
                <ui:param name="update" value="pgrNewIncomeExpense" />
                <ui:param name="btnSaveId" value="#{incomeExpenseProcessBean.getRendered(159, 0)}" />
                <ui:param name="btnDeleteId" value='false' /> 
                <c:if test="#{incomeExpenseProcessBean.processType==2}">
                    <ui:param name="btnDeleteId" value="#{incomeExpenseProcessBean.getRendered(160, 0)}" />
                    <ui:param name="btnTestBeforeDeleteId" value='true' />

                </c:if>
            </ui:include>

            <h:panelGroup id="pgrNewIncomeExpense" layout="block">
                <div class="ui-g-12 divContent">    
                    <div class="ui-g-12">
                        <p:focus for="txtName"/>

                        <div class="#{incomeExpenseProcessBean.processType==1 or incomeExpenseProcessBean.processType==3 ? 'ui-g-12 ui-md-3  ui-lg-3' : 'ui-g-12 ui-md-6  ui-lg-3'} ">
                            <p:outputLabel value="#{incomeExpenseProcessBean.selectedObject.isIncome ? loc.incomename : loc.expensename}" for="txtName" styleClass="Fs12 FontBold"/>
                            <p:inputText id="txtName" value="#{incomeExpenseProcessBean.selectedObject.name}" required="true" placeholder="#{loc.name}" >
                                <p:keyFilter regEx="/[^\\\{\}\[\]\,\:\u0022]/" preventPaste="false" />
                                <f:validateRegex pattern="[^\\\{\}\[\]\,\:\u0022]*" />
                            </p:inputText>
                        </div>
                        <h:panelGroup rendered="#{incomeExpenseProcessBean.processType==1 or incomeExpenseProcessBean.processType==3}">
                            <div class="ui-g-12 ui-md-3 ui-lg-3">
                                <p:outputLabel value="#{loc.transferbalance}" for="txtTransferBalance" styleClass="Fs12 FontBold" />
                                <p:inputNumber id="txtTransferBalance" value="#{incomeExpenseProcessBean.incomeExpenseMovement.price}"
                                               decimalSeparator="#{sessionBean.user.lastBranch.decimalsymbol==1 ? '.': ','}" thousandSeparator="#{sessionBean.user.lastBranch.decimalsymbol==1 ? ',': '.'}" 
                                               roundMethod="D"  symbolPosition="#{sessionBean.locale=='tr' ? 's': 'p'}" symbol="#{sessionBean.currencySignOrCode(sessionBean.user.lastBranch.currency.id, 0)}"
                                               class="Wid90 TexAlRight" placeholder="#{loc.transferbalance}" required="true" >                 
                                </p:inputNumber>
                            </div>
                        </h:panelGroup>
                        <div class="#{incomeExpenseProcessBean.processType==1 or incomeExpenseProcessBean.processType==3 ? 'ui-g-12 ui-md-6  ui-lg-6' : 'ui-g-12 ui-md-6  ui-lg-5'} ">
                            <p:panelGrid layout="grid" columns="1" class="pngCheckBoxReport" style="margin-top: 22px !important" > 
                                <p:selectBooleanCheckbox  value="#{incomeExpenseProcessBean.selectedObject.isProfitMarginReport}" itemLabel="#{loc.reflecttoprofitlossreport}" class="Fleft" styleClass="Fs13 FontBold">
                                    <p:ajax global="false" />
                                </p:selectBooleanCheckbox>
                            </p:panelGrid>

                        </div>

                    </div>
                </div>
            </h:panelGroup>


        </h:form> 
        <c:if test="#{incomeExpenseProcessBean.selectedObject.parentId.id!=0}">
            <div class="EmptyBox10" />

            <p:tabView id="tbvMovement" rendered="#{incomeExpenseProcessBean.processType==2 and incomeExpenseProcessBean.getRendered(45, 1)}" scrollable="true" >
                <p:ajax event="tabChange" listener="#{incomeExpenseProcessBean.onTabChange}" update="pngIncomeExpenseBook"/>
                <p:tab id="tab45" title="#{loc.movements}" rendered="#{incomeExpenseProcessBean.getRendered(45, 1)}">
                    <c:if test="#{incomeExpenseProcessBean.activeIndex==45}" >
                        <ui:include src="/pages/finance/incomeexpense/incomeexpensemovementtab.xhtml"   />
                    </c:if>
                </p:tab>
            </p:tabView>
        </c:if>
    </p:dialog>

    <p:dialog id="dlgTransferBalance" widgetVar="dlg_TransferBalance" resizable="false" width="20%" focus="dlgTransferBalance" responsive="true" dynamic="true" modal="true" closeOnEscape="true">
        <c:if test="#{incomeExpenseProcessBean.activeIndex==45}" >
            <h:form id="frmTransferBalance">
                <ui:include src="/pages/general/common/processtoolbar.xhtml" >
                    <ui:param name="outputtext" value="#{loc.transferbalanceprocesses}"/>
                    <ui:param name="bean" value='#{incomeExpenseMovementTabBean}' />
                    <ui:param name="update" value="pgrTransferBalance" />
                    <ui:param name="btnSaveId" value="#{incomeExpenseMovementTabBean.getRendered(266, 0)}" />     
                    <ui:param name="renderback" value='false'/>
                    <ui:param name="btnDeleteId" value='false' />
                </ui:include>

                <p:focus for="txtDlgTransferBalance"/>
                <h:panelGroup id="pgrTransferBalance" layout="block">
                    <div class="ui-g-12 divContent">

                        <div class="ui-g-12 ui-md-12 ui-lg-12">
                            <p:outputLabel value="#{loc.transferbalance}" for="txtDlgTransferBalance" class="FontBold Fs12"/>
                            <p:inputNumber id="txtDlgTransferBalance" value="#{incomeExpenseMovementTabBean.selectedObject.price}"
                                           decimalSeparator="#{sessionBean.user.lastBranch.decimalsymbol==1 ? '.': ','}" thousandSeparator="#{sessionBean.user.lastBranch.decimalsymbol==1 ? ',': '.'}" 
                                           roundMethod="D"  symbolPosition="#{sessionBean.locale=='tr' ? 's': 'p'}" symbol="#{sessionBean.currencySignOrCode(sessionBean.user.lastBranch.currency.id, 0)}"
                                           class="Wid90 TexAlRight" placeholder="#{loc.transferbalance}" required="true">                 
                            </p:inputNumber>
                        </div>

                    </div>
                </h:panelGroup>
            </h:form>
        </c:if>
    </p:dialog>   

    <p:confirmDialog id="dlgRelatedRecordInfo" global="true"  class="deleteConfirm controlDelete" severity="alert" widgetVar="dlg_RelatedRecordInfo" closeOnEscape="true" width="20%" responsive="true">
      <c:if test="#{incomeExpenseProcessBean.activeIndex==45}" >
        <f:facet name="message">
            <p:panel class="divContent">
                <div class="ui-g">
                    <div class="ui-g-12 ui-md-12 ui-lg-12">
                        <h:outputText value="#{incomeExpenseMovementTabBean.deleteControlMessage}" style="color:black !important"/>
                    </div>
                    <div class="ui-g-12 ui-md-12 ui-lg-12">
                        <h:outputText value="#{incomeExpenseMovementTabBean.deleteControlMessage1}" style="color:black !important"/>
                    </div>
                    <h:panelGroup rendered="#{incomeExpenseMovementTabBean.response != -106}">
                        <div class="ui-g-12 ui-md-12 ui-lg-6">
                            <h:outputText value="#{incomeExpenseMovementTabBean.deleteControlMessage2}" class="Fright"/>
                        </div>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{incomeExpenseMovementTabBean.response == -106}">
                        <div class="ui-g-12 ui-md-12 ui-lg-12">
                            <h:outputText value="#{incomeExpenseMovementTabBean.deleteControlMessage2}"/>
                        </div>
                    </h:panelGroup>
                    <div class="ui-g-12 ui-md-12 ui-lg-6">
                        <p:commandLink value="#{incomeExpenseMovementTabBean.relatedRecord}" class="Fleft cmdRelatedRecord" title="#{loc.gotorelatedrecord}" actionListener="#{incomeExpenseMovementTabBean.goToRelatedRecordBefore()}"/>
                    </div>
                </div>
            </p:panel>
        </f:facet>
      </c:if>
    </p:confirmDialog>

    <p:dialog id="dlgFinancingDocumentProc" widgetVar="dlg_financingdocumentproc" resizable="false" width="50%" focus="dlgFinancingDocumentProc" responsive="true" dynamic="true" modal="true" closeOnEscape="true">
       <c:if test="#{incomeExpenseProcessBean.activeIndex==45}" >
           <ui:include src="/pages/finance/financingdocument/financingdocumentformovement.xhtml" >
               <ui:param name="financingDocument" value="#{incomeExpenseMovementTabBean.selectedObject.financingDocument}"/>
               <ui:param name="bean" value='#{incomeExpenseMovementTabBean}' />
               <ui:param name="type" value='incomeexpense' />
           </ui:include>
       </c:if>
    </p:dialog>


    <h:panelGroup id="pngIncomeExpenseBook">
        <c:if test="#{incomeExpenseProcessBean.activeIndex==45}" >
            <p:overlayPanel id="olpIncomeExpense" widgetVar="olp_IncomeExpense" showEvent="none" modal="true" transient="true"  my="right top" at="left bottom" dismissable="true" hideEffect="blind" showCloseIcon="true" class="Wid30">
                <ui:include src="/pages/general/common/incomeexpensebook.xhtml">
                    <ui:param name="updateBean" value='#{incomeExpenseMovementTabBean}' />
                    <ui:param name="type" value='#{incomeExpenseMovementTabBean.beanName}' />
                    <ui:param name="parameters" value='#{[incomeExpenseMovementTabBean.isIncomeExpense, sessionBean.user.lastBranch]}' /> 
                    <ui:param name="form" value='frmIncomeExpenseBookFilter' /> 
                </ui:include>
            </p:overlayPanel>
        </c:if>
    </h:panelGroup>
    
     <p:confirmDialog id="dlgCommissionWarning" global="true"  class="deleteConfirm controlDelete" severity="alert" widgetVar="dlg_CommissionWarning" closeOnEscape="true" width="20%" responsive="true">
        <c:if test="#{incomeExpenseProcessBean.activeIndex==45}" >
            <f:facet name="message">
                <p:panel class="divContent">
                    <div class="ui-g">
                        <div class="ui-g-12 ui-md-12 ui-lg-12">
                            <h:outputText value="#{incomeExpenseMovementTabBean.commissionMessage}" style="color:black !important"/>
                        </div>
                        <div class="ui-g-12 ui-md-12 ui-lg-6">
                            <p:commandButton value="#{loc.yes}" action="#{incomeExpenseMovementTabBean.updateCommission()}" onclick="PF('dlg_CommissionWarning').hide()" process="@this" styleClass="ui-confirmdialog-yes" icon="ui-icon-check fa fa-check Fs14 white"   />
                        </div>
                        <div class="ui-g-12 ui-md-12 ui-lg-6">
                            <p:commandButton value="#{loc.no}" type="button" onclick="PF('dlg_CommissionWarning').hide()" styleClass="ui-confirmdialog-no" icon="ui-icon-close fa fa-close Fs14 white" />
                        </div>
                    </div>
                </p:panel>
            </f:facet>
        </c:if>
    </p:confirmDialog>
    
    <p:confirmDialog id="dlgCommissionDelete" global="true"  class="deleteConfirm controlDelete" severity="alert" widgetVar="dlg_CommissionDelete" closeOnEscape="true" width="20%" responsive="true">
        <c:if test="#{incomeExpenseProcessBean.activeIndex==45}" >
            <f:facet name="message">
                <p:panel class="divContent">
                    <div class="ui-g">
                        <div class="ui-g-12 ui-md-12 ui-lg-12">
                            <h:outputText value="#{incomeExpenseMovementTabBean.commissionMessage}" style="color:black !important"/>
                        </div>
                        <div class="ui-g-12 ui-md-12 ui-lg-6">
                            <p:commandButton value="#{loc.yes}" action="#{incomeExpenseMovementTabBean.deleteCommission()}" onclick="PF('dlg_CommissionDelete').hide()" process="@this" styleClass="ui-confirmdialog-yes" icon="ui-icon-check fa fa-check Fs14 white"   />
                        </div>
                        <div class="ui-g-12 ui-md-12 ui-lg-6">
                            <p:commandButton value="#{loc.no}" type="button" onclick="PF('dlg_CommissionDelete').hide()" styleClass="ui-confirmdialog-no" icon="ui-icon-close fa fa-close Fs14 white" />
                        </div>
                    </div>
                </p:panel>
            </f:facet>
        </c:if>
    </p:confirmDialog>
   

    <!--Print butonuna basınca çalışan kısım-->
    <p:panel id="printerContainer" style="display: none"  >
        <p:panelGrid id="printerPanel" >

        </p:panelGrid>
    </p:panel> 



    <script type="text/javascript">
        function print_page() {
            var divContents = $("#printerPanel").html();
            var printWindow = window.open('', '', 'height=400,width=800');
            printWindow.document.write('<div style="text-align:center; font-weight:bold; font-family:sans-serif;">#{loc.movements}</div>');
            printWindow.document.write('<div id="printerDiv">');
            printWindow.document.write(divContents);
            printWindow.document.write('</div>');
            printWindow.document.close();
            printWindow.print();

        }
    </script>



</ui:composition>
