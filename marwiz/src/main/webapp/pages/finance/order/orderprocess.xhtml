<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">


    <h:form id="frmOrderProcess">  
        <ui:include src="/pages/general/common/processtoolbar.xhtml" >
            <ui:param name="outputtext" value="#{loc.orderprocesses}"/>
            <ui:param name="bean" value='#{orderProcessBean}' />
            <ui:param name="update" value="pgrOrderProcess" />
            <ui:param name="btnSaveId" value="#{orderProcessBean.selectedObject.status.id!=60 ? orderProcessBean.getRendered(332, 0) : 'false'}" />
            <ui:param name="renderback" value='true'/>
            <ui:param name="createExcelBeforeAsk" value='#{orderProcessBean.processType==2}'/>
            <ui:param name="labelCreateExcelBeforeAsk" value='#{loc.transfertoexcel}'/>
            <c:if test="#{orderProcessBean.processType==2}">
                <ui:param name="btnDeleteId" value="#{(orderProcessBean.processType==2) ? orderProcessBean.getRendered(333, 0) : 'false'}" />
                <ui:param name="btnTestBeforeDeleteId" value="#{(orderProcessBean.processType==2)}" />
            </c:if>
        </ui:include>

        <div class="divContent ui-g-12">
            <h:panelGroup id="pgrOrderProcess" layout="block">  
                <div class="ui-g panelToggle">
                    <h:panelGroup rendered="#{orderProcessBean.listOfBranch.size() > 1}">
                        <div class="ui-g-12 ui-md-3 ui-lg-2">
                            <p:outputLabel value="#{loc.branch}" for="slcBranch" styleClass="Fs12 FontBold"/>
                            <p:selectOneMenu id="slcBranch" value="#{orderProcessBean.selectedObject.branchSetting.branch.id}" disabled="#{orderProcessBean.processType==2}">
                                <f:selectItem itemValue="#{null}" itemLabel="#{loc.choose}" itemDisabled="true"/>
                                <f:selectItems value="#{orderProcessBean.listOfBranch}" var="branchSetting" itemValue="#{branchSetting.branch.id}" itemLabel="#{branchSetting.branch.name}" />
                                <p:ajax update="pgrOrderProcess" listener="#{orderProcessBean.changeBranch()}" process="@this"/>
                            </p:selectOneMenu>
                        </div>
                    </h:panelGroup> 
                    <div class="ui-g-12 ui-md-4 ui-lg-4">
                        <p:outputLabel value="#{loc.current}" for="txtAccountName" styleClass="Fs12 FontBold"/>
                        <p:inputText id="txtAccountName" onclick="#{orderProcessBean.processType==1 ? 'showBook()' : ''}" value="#{orderProcessBean.selectedObject.account.name}" class="inputPositionForBookFilter" required="true" 
                                     readonly="#{facesContext.currentPhaseId.ordinal ge 4}" placeholder="#{loc.currentname}">

                        </p:inputText>
                        <p:commandLink id="btnAccountName" rendered="#{orderProcessBean.processType==1}" class="commandLinkPositionForBookFilter" process="@this" oncomplete="PF('olp_account').loadContents();" >
                            <i class="fa fa-book Fs16 softgray iconPositionForBookFilter "/>   
                            <p:ajax listener="#{accountBookFilterBean.findFilterListLazyLoading([orderProcessBean.selectedObject.branchSetting.branch],'frmAccountBookFilter','olp_account','order')}" global="false" />
                        </p:commandLink>
                    </div>

                    <div class="ui-g-12 ui-md-4 ui-lg-2">
                        <p:outputLabel value="#{loc.statu}" for="slcStatu" styleClass="Fs12 FontBold"/>
                        <p:selectOneMenu id="slcStatu" required="true" disabled="true" value="#{orderProcessBean.selectedObject.status.id}" styleClass="Wid95" >
                            <f:selectItems value="#{orderProcessBean.listOfStatus}"  var="statu" itemLabel="#{statu.nameMap.get(sessionBean.langId).name}" 
                                           itemValue="#{statu.id}"  />
                        </p:selectOneMenu>
                    </div>

                    <h:panelGroup rendered="#{orderProcessBean.selectedObject.type.id==100}">

                    <div class="ui-g-12 ui-md-2 ui-lg-1">
                        <p:outputLabel value="#{loc.serialno}" for="slcDocumentNumber" styleClass="Fs12 FontBold"/>
                        <p:selectOneMenu id="slcDocumentNumber" required="true" value="#{orderProcessBean.selectedObject.dNumber.id}" 
                                         styleClass="Wid95"  >
                            <f:selectItem itemLabel="#{loc.choose}" itemValue="0" itemDisabled="true" />
                            <f:selectItems value="#{orderProcessBean.listOfDocumentNumber}"  var="dnumber" itemLabel="#{dnumber.serial}" itemValue="#{dnumber.id}" />
                            <p:ajax listener="#{orderProcessBean.bringDocument}" global="false" delay="100" process="@this" update="txtDocumentNumber2" />
                        </p:selectOneMenu>
                    </div>
                    <div class="ui-g-12 ui-md-2 ui-lg-1">
                        <p:outputLabel value="#{loc.orderno}" for="txtDocumentNumber2" styleClass="Fs12 FontBold"/>
                        <p:inputNumber id="txtDocumentNumber2" value="#{orderProcessBean.selectedObject.dNumber.actualNumber}" required="true" 
                                       styleClass="Wid95" placeholder="#{loc.number}"
                                       thousandSeparator="" decimalSeparator="." decimalPlaces="0" minValue="0"
                                       />
                    </div>

                    </h:panelGroup>
                    <h:panelGroup rendered="#{orderProcessBean.selectedObject.type.id!=100}">
                        <div class="ui-g-12 ui-md-4 ui-lg-2">
                            <p:outputLabel value="#{loc.documentnumber}" for="txtDocumentNumber" styleClass="Fs12 FontBold"/>
                            <p:inputText id="txtDocumentNumber" value="#{orderProcessBean.selectedObject.documentNo}"  required="true" 
                                         readonly="#{facesContext.currentPhaseId.ordinal ge 4}" placeholder="#{loc.currentname}">

                            </p:inputText>
                        </div>
                    </h:panelGroup>
                    <div class="ui-g-12 ui-md-4 ui-lg-2">
                        <p:outputLabel value="#{loc.orderdate}" for="cldOrderDate" styleClass="Fs12 FontBold"/>
                        <p:calendar  id="cldOrderDate" value="#{orderProcessBean.selectedObject.orderDate}" required="true" class="datepicker" 
                                     beforeShow="dpClearButton" pattern="#{sessionBean.user.lastBranch.dateFormat} HH:mm:ss" showOn="button" 
                                     showButtonPanel="true" placeholder="#{loc.orderdate}" mask="true" navigator="true" timeControlType="select"
                                     locale="#{sessionBean.locale}" yearRange="c-100:c+20"  >
                        </p:calendar>
                    </div>
                </div>

            </h:panelGroup>
        </div>
        <div class="EmptyBox10"></div>
        <p:remoteCommand name="showBook" process="@this" oncomplete="PF('olp_account').loadContents();" actionListener="#{accountBookFilterBean.findFilterListLazyLoading([orderProcessBean.selectedObject.branchSetting.branch],'frmAccountBookFilter','olp_account','order')}" global="false" />
        <p:remoteCommand name="goToRelatedRecordOrder" actionListener="#{orderProcessBean.goToRelatedRecord()}" delay="200"/>
        <h:commandLink id="btnSecretExcel" style="display: none"   immediate="true"  actionListener="#{orderProcessBean.createExcelFile}"  >
            <i class="icon-file-excel tlbrExcelBtn Fs22"/>                 
        </h:commandLink>
        <p:remoteCommand name="bringExcel" async="false"   oncomplete="transferExcel();" />
    </h:form> 

    <p:tabView id="tbvOrder" activeIndex="#{marwiz.tabIndex}" rendered="#{orderProcessBean.processType==2 and (orderProcessBean.getRendered(73, 1) or orderProcessBean.getRendered(74, 1) or orderProcessBean.getRendered(77, 1))}" scrollable="true" cache="true"  dynamic="true">
        <p:ajax event="tabChange" listener="#{orderProcessBean.onTabChange}" update="tbvOrder"/>

        <p:tab id="tab73" title="#{loc.stocks}" rendered="#{orderProcessBean.getRendered(73, 1)}">
            <c:if test="#{orderProcessBean.activeIndex==73}">
                <ui:include src="/pages/finance/order/orderitemtab.xhtml"/>
            </c:if>
        </p:tab>
        
        <p:tab id="tab77" title="#{loc.relatedrecords}" rendered="#{orderProcessBean.getRendered(77, 1)}">
            <c:if test="#{orderProcessBean.activeIndex==77}">
                <ui:include src="/pages/finance/order/orderrelatedrecords.xhtml"/>
            </c:if>
        </p:tab>

        <p:tab id="tab74" title="#{loc.history}" rendered="#{orderProcessBean.getRendered(74, 1)}">
            <c:if test="#{orderProcessBean.activeIndex==74}">
                <ui:include src="/pages/general/common/historydatatable.xhtml" >
                    <ui:param name="bean" value='#{historyTabBean}' />
                    <c:set var="createdPerson" value='#{orderProcessBean.selectedObject.userCreated.fullName}- #{orderProcessBean.selectedObject.userCreated.username }' scope="request"/>
                    <c:set var="createdTime" value='#{sessionBean.convertDateTime(orderProcessBean.selectedObject.dateCreated)}'  scope="request"/>
                    <c:set var="rowId" value="#{orderProcessBean.selectedObject.id}" scope="request" /> 
                    <c:set var="tableName" value="finance.order" scope="request"/>
                    <c:set var="renderedOutput" value="true" scope="request"/>
                    <c:set var="renderedFilter" value="true" scope="request"/>
                </ui:include> 
            </c:if>
        </p:tab> 

    </p:tabView>
    
    <p:confirmDialog global="true" class="deleteConfirm"  widgetVar="dlg_ConfirmStatus" showEffect="fade" hideEffect="fade"  closeOnEscape="true" responsive="true">
        <f:facet name="message">
            <h:outputText value="#{loc.ordercontrolstatus}"  style="white-space: pre-wrap;">
                <i class="icon-trash Fs20 tlbrDeleteBtn" /> 
            </h:outputText>
            <br/>
            <h:outputText value="#{loc.areyousureyouwanttocontinue}"  style="white-space: pre-wrap;">
            </h:outputText>
        </f:facet>
        <p:commandButton value="#{loc.yes}" actionListener="#{orderProcessBean.apprroveExcel()}"  onclick="PF('dlg_ConfirmStatus').hide()"   styleClass="ui-confirmdialog-yes" icon="ui-icon-check fa fa-check Fs14 white"   />
        <p:commandButton value="#{loc.no}"  onclick="PF('dlg_ConfirmStatus').hide()" styleClass="ui-confirmdialog-no" icon="ui-icon-close fa fa-close Fs14 white" />
    </p:confirmDialog>
    
    <p:confirmDialog id="dlgOrderQuantityMessage" global="true" class="deleteConfirm"  widgetVar="dlg_OrderQuantityMessage" showEffect="fade" hideEffect="fade"  closeOnEscape="true" responsive="true">
        <f:facet name="message">
            <h:outputText value="#{orderItemTabBean.orderQuantityMessage}"  style="white-space: pre-wrap;">
                <i class="icon-trash Fs20 tlbrDeleteBtn" /> 
            </h:outputText>
            <br/>
            <h:outputText value="#{loc.areyousureyouwanttocontinue}"  style="white-space: pre-wrap;">
            </h:outputText>
        </f:facet>
        <p:commandButton value="#{loc.yes}" actionListener="#{orderItemTabBean.setOrderQuantity()}"  onclick="PF('dlg_OrderQuantityMessage').hide()"   styleClass="ui-confirmdialog-yes" icon="ui-icon-check fa fa-check Fs14 white"   />
        <p:commandButton value="#{loc.no}"  onclick="PF('dlg_OrderQuantityMessage').hide()" styleClass="ui-confirmdialog-no" icon="ui-icon-close fa fa-close Fs14 white" />
    </p:confirmDialog>
    
    <p:dialog id="dlgDescription" widgetVar="dlg_description" resizable="false" class="dialogScroll" width="25%" modal="true" focus="dlgDescription" responsive="true" dynamic="true" closeOnEscape="true">
        <h:form id="frmDescription"> 
            <p:toolbar >

                <f:facet name="left">
                    <h:outputText value="#{loc.adddescription}" class="outputTextFont Fleft MarRight8" />
                </f:facet>
                <f:facet name="right">  
                    <p:commandLink id="btnSave" title="#{loc.save}" process="@form"  class="Fright MarLeft3"  actionListener="#{orderItemTabBean.saveDescription()}"  >
                        <i class="fa fa-save Fs20 MarTop5 tlbrSaveBtn"/>                 
                    </p:commandLink> 
                </f:facet>
                
            </p:toolbar> 

            <div class="divContent ui-g-12">
                <p:outputLabel value="#{loc.description}" for="txtDescription"  styleClass="Fs12 FontBold"/>
                <p:inputText id="txtDescription" value="#{orderItemTabBean.selectedOrderItemForDescription.description}"   placeholder="#{loc.description}" >
                </p:inputText>
            </div>
            <div class="EmptyBox10"/>
        </h:form>
    </p:dialog>
    
    <!--Stok tabında yeni stok eklemek ve update yapmak için açılan dialog !!! -->
    <p:dialog id="dlgStockProcess" widgetVar="dlg_StockProcess" resizable="false" focus="dlgStockProcess" responsive="true" dynamic="true" modal="true" closeOnEscape="true" width="30%" >
        <ui:include src="orderitemtabprocess.xhtml"/>
    </p:dialog> 
    
        <!-- İrsaliye Silme kontrol -->
    <p:confirmDialog id="dlgRelatedRecordInfoOrder"  class="deleteConfirm controlDelete"  widgetVar="dlg_RelatedRecordInfoOrder" closable="true" width="20%" responsive="true">
        <f:facet name="message">
            <p:panel class="divContent">
                <div class="ui-g">
                    <div class="ui-g-12 ui-md-12 ui-lg-12">
                        <h:outputText value="#{orderProcessBean.deleteControlMessage}" />
                    </div>
                    <div class="ui-g-12 ui-md-12 ui-lg-12">
                        <h:outputText value="#{orderProcessBean.deleteControlMessage1}" />
                    </div>
                    <div class="ui-g-12 ui-md-12 ui-lg-6">
                        <h:outputText rendered="#{orderProcessBean.checkDelete.r_response!=1}" value="#{orderProcessBean.deleteControlMessage2}" class="Fright"/>
                    </div>
                    <div class="ui-g-12 ui-md-12 ui-lg-6">
                        <p:commandLink rendered="#{orderProcessBean.checkDelete.r_response!=1}" value="#{orderProcessBean.relatedRecord}" class="Fleft cmdRelatedRecord" title="#{loc.gotorelatedrecord}" actionListener="#{orderProcessBean.goToRelatedRecordBefore()}" />
                    </div>
                    <div class="ui-g-12 ui-md-12 ui-lg-6">
                        <p:commandButton rendered="#{orderProcessBean.checkDelete.r_response==1}" value="#{loc.yes}" actionListener="#{orderProcessBean.delete()}" async="true" global="true" onclick="PF('dlg_RelatedRecordInfoOrder').hide()"   styleClass="ui-confirmdialog-yes" icon="ui-icon-check fa fa-check Fs14 white"   />
                    </div>
                    <div class="ui-g-12 ui-md-12 ui-lg-6">
                        <p:commandButton rendered="#{orderProcessBean.checkDelete.r_response==1}" value="#{loc.no}"  onclick="PF('dlg_RelatedRecordInfoOrder').hide()" styleClass="ui-confirmdialog-no" icon="ui-icon-close fa fa-close Fs14 white" />
                    </div>
                </div>
            </p:panel>
        </f:facet>
    </p:confirmDialog>
    
    <ui:include src="/pages/general/common/stockbook.xhtml" >
        <ui:param name="updateBean" value='#{orderItemTabBean}' />
        <ui:param name="for" value='frmManuelOrderItem:btnStock' />
        <ui:param name="type" value="ordermanuel" />
        <ui:param name="parameters" value="#{[orderItemTabBean.selectedOrder,orderItemTabBean.listOfObjects]}" /> 
        <ui:param name="columnsize" value='5' /> 
        <ui:param name="form" value='frmStockBookFilter' /> 
        <ui:param name="overlay" value="olp_stock" />
        <ui:param name="renderedNumberColumn" value="true" />
   </ui:include>

    <h:panelGroup id="pngAccountBook">
        <!-- fatura sayfasında hızlı cari eklemek ve cari değiştirmek için -->
        <ui:include src="/pages/general/common/accountbook.xhtml" >
            <ui:param name="updateBean" value='#{orderProcessBean}' />
            <ui:param name="for" value="frmOrderProcess:btnAccountName" />
            <ui:param name="type" value='order' />
            <ui:param name="parameters" value='#{[orderProcessBean.selectedObject.branchSetting.branch]}' /> 
            <ui:param name="columnsize" value='2' /> 
            <ui:param name="form" value='frmAccountBookFilter' /> 
            <ui:param name="overlay" value="olp_account" />
        </ui:include>
    </h:panelGroup>
    
    <script type="text/javascript">
        function transferExcel() {
            document.getElementById("frmOrderProcess:btnSecretExcel").click();
        }
    </script>


</ui:composition>

