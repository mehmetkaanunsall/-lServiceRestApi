<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">







    <h:form id="frmMovementDataTable">


        <p:dataTable  id="dtbMovement" var="movement"  value="#{accountMovementTabBean.listOfObjects}" widgetVar="movementPF" selection="#{accountMovementTabBean.selectedObject}"  selectionMode="single" emptyMessage="#{loc.norecordsfound}"
                      rowsPerPageTemplate="#{sessionBean.user.gridSize}" rows="#{sessionBean.user.defualtGridSize}"  rowKey="#{movement.id}" paginator="true" paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown} {CurrentPageReport}"
                      paginatorPosition="bottom" currentPageReportTemplate="{startRecord}-{endRecord} #{loc.intotal} {totalRecords}" 
                      reflow="true" lazy="true">
            
            <p:ajax event="#{sessionBean.user.gridRowSelect}" listener="#{accountMovementTabBean.getfinancingDocument()}" global="false" resetValues="true"/>  

            <p:column id="clmBranch" headerText="#{loc.branch}" >
                <h:outputText value="#{movement.branch.name}"/>
            </p:column>
            <p:column id="clmMovementDate" headerText="#{loc.documentdate}"  >
                <h:outputText value="#{(movement.financingDocument.id >0 ? movement.financingDocument.documentDate : movement.invoice.id>0 ? movement.invoice.invoiceDate : movement.receipt.id>0 ? movement.receipt.processDate : movement.movementDate)}">
                    <f:convertDateTime pattern="#{sessionBean.user.lastBranch.dateFormat} HH:mm:ss" />
                </h:outputText>
            </p:column>


            <p:column id="clmDocumentNumber" headerText="#{loc.documentnumber}" >
                <h:outputText value="#{(movement.financingDocument.id==0 and movement.invoice.id==0 and movement.chequeBill.id==0 and movement.receipt.id==0) ? loc.transferbalance : 
                                       movement.financingDocument.id >0 ? movement.financingDocument.documentNumber : 
                                       movement.invoice.id>0 ? movement.invoice.documentNumber : 
                                       movement.chequeBill.id>0 ? movement.chequeBill.portfolioNumber : movement.receipt.receiptNo}"/>
            </p:column>
            <p:column id="clmCreatedDate" headerText="#{loc.createddate}" >
                <h:outputText value="#{movement.dateCreated}">
                    <f:convertDateTime pattern="#{sessionBean.user.lastBranch.dateFormat} HH:mm:ss" />
                </h:outputText>
            </p:column>
            <p:column id="clmCreatedPerson" headerText="#{loc.createdperson}" >
                <h:outputText value="#{movement.userCreated.id==0 ? '' : movement.userCreated.fullName}"/>
            </p:column>
            <p:column id="clmUpdatedDate" headerText="#{loc.updateddate}" >
                <h:outputText value="#{movement.dateUpdated}">
                    <f:convertDateTime pattern="#{sessionBean.user.lastBranch.dateFormat} HH:mm:ss" />
                </h:outputText>
            </p:column>
            <p:column id="clmUpdatedPerson" headerText="#{loc.updatedperson}"  >
                <h:outputText value="#{movement.userUpdated.id==0 ? '' : movement.userUpdated.fullName}"/>
            </p:column>

            <p:column id="clmTermDate" headerText="#{loc.termdate}" >
                <h:outputText value="#{movement.invoice.id >0 ? movement.invoice.dueDate : ''}">
                    <f:convertDateTime pattern="#{sessionBean.user.lastBranch.dateFormat} HH:mm:ss" />
                </h:outputText>
            </p:column>
            
            
            <p:column id="clmDescription" headerText="#{loc.description}"  >
                <h:outputText value="#{movement.financingDocument.description}"/>
            </p:column>

            <p:column id="clmFinancingDocumentType" headerText="#{loc.processtype}" >
                <h:outputText value="#{(movement.financingDocument.id==0 and movement.invoice.id==0 and movement.chequeBill.id==0 and movement.receipt.id==0) ? '' : movement.financingDocument.id >0 ? movement.financingDocument.financingType.tag : 
                                       (movement.invoice.id>0 and movement.invoice.isPurchase) ? loc.purchaseinvoice : (movement.invoice.id>0 and !movement.invoice.isPurchase) ? loc.salesinvoice : 
                                       movement.chequeBill.id>0 ? loc.chequebill : loc.receipt}"/>
            </p:column>


            <p:columnGroup type="header">
                <p:row>
                    <p:column rowspan="2"  headerText="#{loc.branch}" sortable="true" sortBy="#{movement.br.name}"/>
                    <p:column rowspan="2"  headerText="#{loc.documentdate}" sortable="true" sortBy="#{movement.financingDocument.documentDate}"/>
                    <p:column rowspan="2"  headerText="#{loc.documentnumber}" sortable="true" sortBy="#{movement.financingDocument.documentNumber}"/>
                    <p:column rowspan="2"  headerText="#{loc.createddate}" sortable="true" sortBy="#{movement.dateCreated}"/>
                    <p:column rowspan="2"  headerText="#{loc.createdperson}" sortable="true" sortBy="#{movement.userCreated.fullName}"/>
                    <p:column rowspan="2"  headerText="#{loc.updateddate}" sortable="true" sortBy="#{movement.dateUpdated}"/>
                    <p:column rowspan="2"  headerText="#{loc.updatedperson}" sortable="true" sortBy="#{movement.userUpdated.fullName}"/>
                    <p:column rowspan="2"  headerText="#{loc.termdate}" sortable="true" sortBy="#{movement.invoice.dueDate}"/>
                    <p:column rowspan="2"  headerText="#{loc.description}" sortable="true" sortBy="#{movement.fdoc.description}"/>
                    <p:column rowspan="2"  headerText="#{loc.processtype}" sortable="true" sortBy="#{movement.financingDocument.financingType.tag}"/>



                    <p:column  colspan="#{sessionBean.lastBranchSetting.isForeignCurrency ? '4' : '3'}" >
                        <f:facet name="header" >
                            <h:outputText id="txtTransferringBalance" value="#{accountMovementTabBean.transferringBalance}" style="float: right;" >
                                <f:converter converterId="currencyConverter" />
                                <f:attribute name="currency" value="#{sessionBean.user.lastBranch.currency}"/>
                                <f:attribute name="type" value="currency" />
                            </h:outputText>

                            <h:outputText rendered="#{accountMovementTabBean.listOfObjects.rowCount>0}" value="#{loc.transferringbalance} : " style="float: right" />
                        </f:facet>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column headerText="#{loc.foreignexchangetransactionamount}" sortable="true" sortBy="#{movement.accm.price}" rendered="#{sessionBean.lastBranchSetting.isForeignCurrency}"/>
                    <p:column headerText="#{loc.debt}" sortable="true" sortBy="#{movement.isDirection}"/>
                    <p:column headerText="#{loc.receivable}" sortable="true" sortBy="#{movement.exchangeRate}"/>
                    <p:column headerText="#{loc.balance}" />
                </p:row>
            </p:columnGroup>


            <p:column id="clmPrice" rendered="#{sessionBean.lastBranchSetting.isForeignCurrency}">
                <p:column>
                    <h:outputText value="#{movement.price}" style="float: right;">
                        <f:converter converterId="currencyConverter" />
                        <f:attribute name="currency" value="#{movement.currency}"/>
                        <f:attribute name="type" value="currency" />
                    </h:outputText>
                </p:column>
            </p:column>

            <p:column id="clmDebt"><!--BorÃ§-->
                <p:column>
                    <h:panelGroup rendered="#{!movement.isDirection}">
                        <h:outputText value="#{movement.price.multiply(movement.exchangeRate)}" style="float: right;">
                            <f:converter converterId="currencyConverter" />
                            <f:attribute name="currency" value="#{sessionBean.user.lastBranch.currency}"/>
                            <f:attribute name="type" value="currency" />
                        </h:outputText>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{movement.isDirection}" style="text-align: center; display: block">
                        <h:outputText value="-"/>
                    </h:panelGroup>
                </p:column>
            </p:column>
            <p:column id="clmReceivable"><!--Alacak-->
                <p:column>
                    <h:panelGroup rendered="#{movement.isDirection}">
                        <h:outputText value="#{movement.price.multiply(movement.exchangeRate)}" style="float: right;">
                            <f:converter converterId="currencyConverter" />
                            <f:attribute name="currency" value="#{sessionBean.user.lastBranch.currency}"/>
                            <f:attribute name="type" value="currency" />
                        </h:outputText>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{!movement.isDirection}" style="text-align: center; display: block">
                        <h:outputText value="-"/>
                    </h:panelGroup>
                </p:column>
            </p:column>
            <p:column id="clmPrice3">
                <p:column>
                    <h:outputText value="#{accountMovementTabBean.convertBalanceSign(movement.balance)}" style="float: right;">
                        <f:converter converterId="currencyConverter" />
                        <f:attribute name="currency" value="#{sessionBean.user.lastBranch.currency}"/>
                        <f:attribute name="type" value="currency" />
                    </h:outputText>
                </p:column>
            </p:column>

            <p:columnGroup type="footer" rendered="#{accountMovementTabBean.listOfObjects.rowCount>0}">
                <p:row>
                    <p:column colspan="#{sessionBean.lastBranchSetting.isForeignCurrency ? '13' : '12'}" style="text-align:right"  rendered="#{accountMovementTabBean.opType==1 or accountMovementTabBean.opType==3}">
                        <f:facet name="footer" >
                            <h:outputText value="#{loc.sumofincoming} : " class="FontBold"  />
                        </f:facet>
                    </p:column>
                    <p:column colspan="1" style="text-align:right"  rendered="#{accountMovementTabBean.opType==1 or accountMovementTabBean.opType==3}">
                        <f:facet name="footer" >
                            <h:outputText  value="#{accountMovementTabBean.totalIncoming}">
                                <f:converter converterId="currencyConverter" />
                                <f:attribute name="currency" value="#{sessionBean.user.lastBranch.currency}"/>
                                <f:attribute name="type" value="currency" />
                            </h:outputText>
                        </f:facet>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column colspan="#{sessionBean.lastBranchSetting.isForeignCurrency ? '13' : '12'}" style="text-align:right"  rendered="#{accountMovementTabBean.opType==2 or accountMovementTabBean.opType==3}">
                        <f:facet name="footer" >
                            <h:outputText value="#{loc.sumofoutcoming} : " class="FontBold"  />
                        </f:facet>
                    </p:column>
                    <p:column colspan="1" style="text-align:right"  rendered="#{accountMovementTabBean.opType==2 or accountMovementTabBean.opType==3}">
                        <f:facet name="footer" >
                            <h:outputText value="#{accountMovementTabBean.totalOutcoming}">
                                <f:converter converterId="currencyConverter" />
                                <f:attribute name="currency" value="#{sessionBean.user.lastBranch.currency}"/>
                                <f:attribute name="type" value="currency" />
                            </h:outputText>
                        </f:facet>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column colspan="#{sessionBean.lastBranchSetting.isForeignCurrency ? '13' : '12'}" style="text-align:right" >
                        <f:facet name="footer" >
                            <h:outputText value="#{loc.totalbalance} : " class="FontBold" style="font-size: 15px; color: #565656;"/>
                        </f:facet>
                    </p:column>
                    <p:column colspan="1" style="text-align:right" >
                        <f:facet name="footer" >
                            <h:outputText  value="#{accountMovementTabBean.convertBalanceSign(accountMovementTabBean.totalBalance)}" class="FontBold" style="font-size: 15px;  color: #565656;">
                                <f:converter converterId="currencyConverter" />
                                <f:attribute name="currency" value="#{sessionBean.user.lastBranch.currency}"/>
                                <f:attribute name="type" value="currency" />
                            </h:outputText>
                            <h:outputText value=" ( #{accountMovementTabBean.manageBalanceSign(accountMovementTabBean.totalBalance) ? loc.payable : loc.receivabled} )" class="FontBold" style="font-size: 15px; color: #565656;"/>
                        </f:facet>
                    </p:column>
                </p:row>
            </p:columnGroup>
        </p:dataTable>  
        <p:remoteCommand name="goToRelatedRecord" actionListener="#{accountMovementTabBean.goToRelatedRecord()}" delay="200"/>
    </h:form>

    <p:dialog id="dlgFinancingDocumentProc" widgetVar="dlg_financingdocumentproc" resizable="false" width="60%" focus="dlgFinancingDocumentProc" responsive="true" dynamic="true" modal="true" closeOnEscape="true">
        <ui:include src="/pages/finance/financingdocument/financingdocumentformovement.xhtml" >
            <ui:param name="financingDocument" value="#{accountMovementTabBean.selectedObject.financingDocument}"/>
            <ui:param name="bean" value='#{accountMovementTabBean}' />
            <ui:param name="type" value='#{type}' />
        </ui:include>
    </p:dialog>
    
    <p:overlayPanel id="olpIncomeExpense" widgetVar="olp_IncomeExpense" showEvent="none" modal="true" transient="true" at="left bottom" dismissable="true" hideEffect="blind" showCloseIcon="true" class="Wid30">
        <ui:include src="/pages/general/common/incomeexpensebook.xhtml">
            <ui:param name="updateBean" value='#{accountMovementTabBean}' />
            <ui:param name="type" value='#{accountMovementTabBean.beanName}' />
            <ui:param name="parameters" value='#{[accountMovementTabBean.isIncomeExpense, accountMovementTabBean.selectedObject.financingDocument.branch]}' /> 
            <ui:param name="form" value='frmIncomeExpenseBookFilter' /> 
        </ui:include>
    </p:overlayPanel>

    <p:dialog id="dlgTransferBalance" widgetVar="dlg_TransferBalance" resizable="false" width="20%" focus="dlgTransferBalance" responsive="true" dynamic="true" modal="true" closeOnEscape="true">

        <h:form id="frmTransferBalance">
            <ui:include src="/pages/general/common/processtoolbar.xhtml" >
                <ui:param name="outputtext" value="#{loc.transferbalanceprocesses}"/>
                <ui:param name="bean" value='#{accountTransferBalanceProcessBean}' />
                <ui:param name="update" value="pgrTransferBalance" />
                <ui:param name="btnSaveId" value="#{accountTransferBalanceProcessBean.getRendered(265, 0)}" />     
                <ui:param name="renderback" value='false'/>
                <ui:param name="btnDeleteId" value='false' />
            </ui:include>

            <p:focus for="txtDlgTransferBalance"/>
            <h:panelGroup id="pgrTransferBalance" layout="block">
                <div class="ui-g-12 divContent">

                    <div class="ui-g-12 ui-md-12 ui-lg-12">
                        <p:outputLabel value="#{loc.transferbalance}" for="txtDlgTransferBalance" class="FontBold Fs12"/>
                        <p:inputNumber id="txtDlgTransferBalance" value="#{accountTransferBalanceProcessBean.selectedObject.price}"
                                       decimalSeparator="#{sessionBean.user.lastBranch.decimalsymbol==1 ? '.': ','}" thousandSeparator="#{sessionBean.user.lastBranch.decimalsymbol==1 ? ',': '.'}" 
                                       roundMethod="D"  symbolPosition="#{sessionBean.locale=='tr' ? 's': 'p'}" symbol="#{sessionBean.currencySignOrCode(sessionBean.user.lastBranch.currency.id, 0)}"
                                       class="Wid90 TexAlRight" placeholder="#{loc.transferbalance}" required="true">                 
                        </p:inputNumber>
                    </div>

                </div>
            </h:panelGroup>
        </h:form>
    </p:dialog>


</ui:composition>
