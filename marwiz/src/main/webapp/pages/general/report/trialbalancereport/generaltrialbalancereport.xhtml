<ui:composition xmlns="http://www.w4.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

    <h:outputScript name="js/d3.min#{sessionBean.user.lastBranch.decimalsymbol == 1 ? '' : '-tr'}.js" library="sentinel-layout"  />
    <h:outputScript name="js/nv.d3.min.js" library="sentinel-layout"  />
    <h:outputStylesheet name="css/nv.d3.min.css" library="sentinel-layout" />

    <h:form id="frmTrialBalance" >
        <ui:include src="/pages/general/common/toolbarreport.xhtml" >
            <ui:param name="outputtext" value="#{loc.generaltrialbalancereport}"/>
            <ui:param name="bean" value='#{trialBalanceBean}' />
            <ui:param name="update" value="frmTrialBalance pgrTrialBalance" />
        </ui:include>

        <div class="divContent noPrint">
            <h:panelGroup id="pgrDate" layout="block" transient="true">     

                <div class="ui-g ">
                    <div class="panelToggle ui-g-12">

                        <div class="ui-g-12 ui-md-6 ui-lg-6 MarTop15">

                            <div class="ui-g-12 ui-md-6 ui-lg-4">
                                <p:outputLabel value="#{loc.startdate}" for="cldStartDate" styleClass="Fs8 FontBold"/>
                                <p:calendar  id="cldStartDate" value="#{trialBalanceBean.beginDate}" class="datepicker marginInput" timeControlType="select"  required="true" beforeShow="dpClearButton" pattern="#{sessionBean.user.lastBranch.dateFormat}" showOn="button" showButtonPanel="true" placeholder="#{loc.date}" mask="true" navigator="true" locale="#{sessionBean.locale}" yearRange="c-100:c+20" disabled="true" >
                                </p:calendar>
                            </div>

                            <div class="ui-g-12 ui-md-6 ui-lg-4">
                                <p:outputLabel value="#{loc.enddate}" for="cldDate" styleClass="Fs8 FontBold"/>
                                <p:calendar  id="cldDate" value="#{trialBalanceBean.endDate}" class="datepicker marginInput" timeControlType="select"  required="true" beforeShow="dpClearButton" pattern="#{sessionBean.user.lastBranch.dateFormat}" showOn="button" showButtonPanel="true" placeholder="#{loc.date}" mask="true" navigator="true" locale="#{sessionBean.locale}" yearRange="c-100:c+20" >
                                    <p:ajax event="dateSelect" update="frmTrialBalance" global="false" listener="#{trialBalanceBean.adjustDates()}"/>
                                </p:calendar>
                            </div>

                            <div class="ui-g-12  ui-md-6 ui-lg-4">
                                <p:outputLabel value="#{loc.branch}" for="slcBranch" styleClass="Fs8 FontBold"/>
                                <p:selectCheckboxMenu  id="slcBranch"  value="#{trialBalanceBean.selectedObject.selectedBranchList}"  style="margin-top: 5px !important"
                                                       filter="true" filterMatchMode="contains" converter="entityConverter" widgetVar="slcBranchCheckBox"  
                                                       label="#{trialBalanceBean.selectedObject.selectedBranchList.size()!=0 ? trialBalanceBean.selectedObject.selectedBranchList.size() :loc.all} #{trialBalanceBean.selectedObject.selectedBranchList.size()!=0 ? loc.branch : ''} #{trialBalanceBean.selectedObject.selectedBranchList.size()!=0 ? loc.selected : ''}" styleClass="Wid90" >
                                    <f:selectItems value="#{trialBalanceBean.listOfBranch}" itemLabel="#{branchSetting.branch.name}" itemValue="#{branchSetting}" var="branchSetting" />       
                                    <p:ajax oncomplete="PF('slcBranchCheckBox').show()" global="false" update="slcBranch"/>
                                    <p:ajax event="toggleSelect" update="slcBranch"  oncomplete="PF('slcBranchCheckBox').show()" global="false"/>
                                </p:selectCheckboxMenu>
                            </div>  


                            <div class="ui-g-12 ui-md-6 ui-lg-6" style="margin-top: 25px">
                                <p:selectBooleanCheckbox value="#{trialBalanceBean.fuelCard}" itemLabel="#{loc.fuelstockcards}">
                                    <p:ajax update="frmTrialBalance:fuelStockMenu"/>
                                </p:selectBooleanCheckbox>

                                <p:selectOneMenu id="fuelStockMenu" disabled="#{!trialBalanceBean.fuelCard}" >
                                    <f:selectItem itemLabel="#{loc.purchasepriceatdeadline} (#{loc.istaxincluded})" itemValue="" />
                                    <f:selectItem itemLabel="#{loc.purchasepriceatdeadline} (#{loc.vatexcluded})" itemValue="" />
                                    <f:selectItem itemLabel="#{loc.salepriceatdeadline} (#{loc.istaxincluded})" itemValue="" />
                                    <f:selectItem itemLabel="#{loc.salepriceatdeadline} (#{loc.vatexcluded})" itemValue="" />
                                </p:selectOneMenu>
                            </div>

                            <div class="ui-g-12 ui-md-6 ui-lg-6" style="margin-top: 25px">
                                <p:selectBooleanCheckbox value="#{trialBalanceBean.marketCard}" itemLabel="#{loc.marketstockcards}">
                                    <p:ajax update="frmTrialBalance:marketStockMenu"/>
                                </p:selectBooleanCheckbox>
                                <p:selectOneMenu id="marketStockMenu" value="#{trialBalanceBean.marketAssign}" disabled="#{!trialBalanceBean.marketCard}">
                                    <f:selectItem itemLabel="#{loc.purchasepriceatdeadline} (#{loc.istaxincluded})" itemValue="1" />
                                    <f:selectItem itemLabel="#{loc.purchasepriceatdeadline} (#{loc.vatexcluded})" itemValue="2" />
                                    <f:selectItem itemLabel="#{loc.salepriceatdeadline} (#{loc.istaxincluded})" itemValue="3" />
                                    <f:selectItem itemLabel="#{loc.salepriceatdeadline} (#{loc.vatexcluded})" itemValue="4" />
                                </p:selectOneMenu>
                            </div>
                        </div>

                        <div class="ui-g-12 ui-md-12 ui-lg-6">
                            <div class="pngCheckBoxReport ui-g-12 divBackgroundColor">


                                <div class="ui-g-12 ui-md-6 ui-lg-4 MarTop5" >
                                    <p:selectBooleanCheckbox value="#{trialBalanceBean.safeChkBox}" itemLabel="#{loc.safe}" class="chkboxTrialBalance">
                                    </p:selectBooleanCheckbox>
                                </div>

                                <div class="ui-g-12 ui-md-6 ui-lg-4 MarTop5" >
                                    <p:selectBooleanCheckbox value="#{trialBalanceBean.bankChkBox}" itemLabel="#{loc.bank}" class="chkboxTrialBalance">
                                    </p:selectBooleanCheckbox>
                                </div>


                                <div class="ui-g-12 ui-md-6 ui-lg-4 MarTop5">
                                    <p:selectBooleanCheckbox value="#{trialBalanceBean.currentChkBox}" itemLabel="#{loc.current}" class="chkboxTrialBalance">
                                    </p:selectBooleanCheckbox>
                                </div>

                                <div class="ui-g-12 ui-md-6 ui-lg-4 MarTop5">
                                    <p:selectBooleanCheckbox value="#{trialBalanceBean.employeeChkBox}" itemLabel="#{loc.employee}" class="chkboxTrialBalance">
                                    </p:selectBooleanCheckbox>
                                </div>

                                <div class="ui-g-12 ui-md-6 ui-lg-4 MarTop5" >
                                    <p:selectBooleanCheckbox value="#{trialBalanceBean.chequeBillChkBox}" itemLabel="#{loc.cheque} / #{loc.bill}" class="chkboxTrialBalance">
                                    </p:selectBooleanCheckbox>
                                </div>

                                <div class="ui-g-12 ui-md-6 ui-lg-4 MarTop5" >
                                    <p:selectBooleanCheckbox value="#{trialBalanceBean.postPaidChkBox}" itemLabel="#{loc.postpaid}" class="chkboxTrialBalance">
                                    </p:selectBooleanCheckbox>
                                </div>

                                <div class="ui-g-12 ui-md-6 ui-lg-4 MarTop5" >
                                    <p:selectBooleanCheckbox value="#{trialBalanceBean.incomeChkBox}" itemLabel="#{loc.income}" class="chkboxTrialBalance">
                                    </p:selectBooleanCheckbox>
                                </div>

                                <div class="ui-g-12 ui-md-6 ui-lg-4 MarTop5" >
                                    <p:selectBooleanCheckbox value="#{trialBalanceBean.expenseChkBox}" itemLabel="#{loc.expense}" class="chkboxTrialBalance">
                                    </p:selectBooleanCheckbox>
                                </div>

                                <!--                                <div class="ui-g-12 ui-md-12 ui-lg-12 MarTop5" >
                                                                </div>-->

                                <div class="ui-g-12 ui-md-6 ui-lg-3 MarTop5" >
                                    <p:selectBooleanCheckbox value="#{trialBalanceBean.incomeexpenseSubgroupChkBox}" itemLabel="#{loc.incomeexpensesubgroup}" class="chkboxTrialBalance" style="width: 207px;">
                                    </p:selectBooleanCheckbox>
                                </div> 

                                <div class="ui-g-12 ui-md-6 ui-lg-4 MarTop5" >
                                    <p:selectBooleanCheckbox value="#{trialBalanceBean.waitingSlipsChkBox}" itemLabel="#{loc.waitingposreceivable}" class="chkboxTrialBalance" style="width: 207px;">
                                    </p:selectBooleanCheckbox>
                                </div>

                            </div>
                        </div>



                    </div>
                </div>
            </h:panelGroup>
        </div>
        <div class="EmptyBox10" />
    </h:form> 

    <h:panelGroup id="pgrTrialBalance">
        <h:panelGroup rendered="#{trialBalanceBean.isFind}">
            <ui:include src="/pages/general/common/datagridtoolbarreport.xhtml" >
                <ui:param name="outputtext" value="#{loc.generaltrialbalancereport}"/>
                <ui:param name="bean" value='#{trialBalanceBean}' />
                <ui:param name="renderedExcel" value="true" />
                <ui:param name="renderedPdf" value="true" />
                <ui:param name="renderedPrint" value="true" />
                <ui:param name="renderedPrintSummary" value="true" />
                <ui:param name="printSummaryField" value="frmFieldSet"/>
            </ui:include>
            <div class="divContent ui-g-12">

                <h:form id="frmFieldSet" >
                    <div class="ui-g-12">
                        <p:fieldset legend="#{loc.income}" toggleable="true" class="incomeFieldSet" style="margin-bottom:10px;height: 97%;" rendered="true">
                            <div class="ui-g-12 ui-md-12 ui-lg-6" >
                                <p:panel>                                        
                                    <div class="ui-g" style="min-height: 220px;">
                                        <ui:repeat value="#{trialBalanceBean.listOfBalance.entrySet().toArray()}" var="entry" >
                                            <h:panelGroup rendered="#{(trialBalanceBean.incomeChkBox and entry.key==5) or entry.key!=5 and entry.key!=9}" >
                                                <div class="ui-g-12 ui-md-6 ui-lg-6" >
                                                    <p:outputLabel  value="#{trialBalanceBean.listOfBalance.get(entry.key).incomeText}" styleClass="Fs13 FontBold" />
                                                    <p:inputText  value="#{trialBalanceBean.listOfBalance.get(entry.key).income}" readonly="true" style="text-align:  right">
                                                        <f:converter converterId="currencyConverter"  />
                                                        <f:attribute name="currency"  value="#{sessionBean.user.lastBranch.currency}"/>
                                                        <f:attribute name="type" value="currency" />
                                                    </p:inputText>
                                                </div>
                                            </h:panelGroup>
                                        </ui:repeat>
                                    </div>
                                </p:panel>
                            </div>
                            <div class="ui-g-12 ui-md-12 ui-lg-6" >
                                <p:panel>
                                    <div id="pnlgrpBalanceIncome" >
                                        <svg style="height: 220px;"></svg>
                                    </div>
                                </p:panel>
                            </div>
                        </p:fieldset>

                        <p:fieldset  legend="#{loc.expense}" toggleable="true" class="expenseFieldSet" style="margin-bottom:10px;height: 97%;">
                            <div class="ui-g-12 ui-md-12 ui-lg-6" >
                                <p:panel>
                                    <div class="ui-g" style="min-height: 200px;">
                                        <ui:repeat value="#{trialBalanceBean.listOfBalance.entrySet().toArray()}" var="entry" >
                                            <h:panelGroup rendered="#{((trialBalanceBean.expenseChkBox and entry.key==5) or entry.key!=5) and entry.key!=7 and entry.key!=8}" >
                                                <div class="ui-g-12 ui-md-6 ui-lg-6" >
                                                    <p:outputLabel  value="#{trialBalanceBean.listOfBalance.get(entry.key).expenseText}" styleClass="Fs13 FontBold" />
                                                    <p:inputText  value="#{trialBalanceBean.listOfBalance.get(entry.key).expense}" readonly="true" style="text-align:  right">
                                                        <f:converter converterId="currencyConverter"  />
                                                        <f:attribute name="currency"  value="#{sessionBean.user.lastBranch.currency}"/>
                                                        <f:attribute name="type" value="currency" />
                                                    </p:inputText>
                                                </div>
                                            </h:panelGroup>
                                        </ui:repeat>
                                    </div>
                                </p:panel> 
                            </div>
                            <div class="ui-g-12 ui-md-12 ui-lg-6">
                                <p:panel>
                                    <div id="pnlgrpBalanceExpense" >
                                        <svg style="height: 221px;"></svg>
                                    </div>
                                </p:panel>
                            </div>
                        </p:fieldset>


                        <p:fieldset legend="#{loc.sum}" class="totalBalanceFieldSet" toggleable="true"  style="margin-bottom:10px;">
                            <div class="ui-g-12 ui-md-4 ui-lg-4">
                                <p:outputLabel for="totalIncome" value="#{loc.totalofincome}" class="Fs15 FontBold" />
                                <p:inputText id="totalIncome" value="#{trialBalanceBean.totalIncome}" readonly="true" style="text-align:  right">
                                    <f:converter converterId="currencyConverter"  />
                                    <f:attribute name="currency"  value="#{sessionBean.user.lastBranch.currency}"/>
                                    <f:attribute name="type" value="currency" />
                                </p:inputText>
                            </div>
                            <div class="ui-g-12 ui-md-4 ui-lg-4">
                                <p:outputLabel for="totalExpense" value="#{loc.totalofexpense}" class="Fs15 FontBold"/>
                                <p:inputText id="totalExpense" value="#{trialBalanceBean.totalOutcome}" readonly="true" style="text-align:  right">
                                    <f:converter converterId="currencyConverter"  />
                                    <f:attribute name="currency"  value="#{sessionBean.user.lastBranch.currency}"/>
                                    <f:attribute name="type" value="currency" />
                                </p:inputText>
                            </div>
                            <div class="ui-g-12 ui-md-4 ui-lg-4">
                                <p:outputLabel for="totalBalance" value="#{loc.overallnetvalue}" class="Fs15 FontBold"/>
                                <p:inputText id="totalBalance" value="#{trialBalanceBean.totalBalance}" readonly="true" style="text-align:  right">
                                    <f:converter converterId="currencyConverter"  />
                                    <f:attribute name="currency"  value="#{sessionBean.user.lastBranch.currency}"/>
                                    <f:attribute name="type" value="currency" />
                                </p:inputText>
                            </div>
                        </p:fieldset>
                    </div>
                </h:form>

                <div class="ui-g-12 ui-md-12 ui-lg-12">
                    <p:fieldset legend="#{loc.detail}" class="detailFieldSet" toggleable="true"  style="margin-bottom:10px;" rendered="true">
                        <p:treeTable class="treetablefortrialbalance" value="#{trialBalanceBean.root}" var="document" selectionMode="single" style="border:0px !important">
                            <p:column headerText="#{loc.accountname}" class="Fs14">
                                <h:outputText value="#{document.name}" />
                            </p:column>
                            <p:column headerText="#{loc.branch}" class="Fs14">
                                <h:outputText value="#{document.branchName}" />
                            </p:column>
                            <p:column headerText="#{loc.income}" rendered="true" class="Fs14">
                                <h:outputText value="" rendered="#{document.income.doubleValue() == -2121.2121}" />
                                <h:outputText value="#{document.income}" class="Fright" rendered="#{document.income.doubleValue() != -2121.2121}">
                                    <f:converter converterId="currencyConverter"  />
                                    <f:attribute name="currency"  value="#{sessionBean.user.lastBranch.currency}"/>
                                    <f:attribute name="type" value="currency" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="#{loc.expense}" rendered="true" class="Fs14"> 
                                <h:outputText value="" rendered="#{document.expense.doubleValue() == -2121.2121}" />
                                <h:outputText value="#{document.expense}" class="Fright" rendered="#{document.expense.doubleValue() != -2121.2121}">
                                    <f:converter converterId="currencyConverter"  />
                                    <f:attribute name="currency"  value="#{sessionBean.user.lastBranch.currency}"/>
                                    <f:attribute name="type" value="currency" />
                                </h:outputText>
                            </p:column>                            
                            
                            <p:column headerText="#{loc.incomebalance}" rendered="true" class="Fs14"> 
                                <h:outputText value="" rendered="#{document.accountName=='5' ?  document.income.doubleValue() == -2121.2121 : trialBalanceBean.calcBalance(document.income,document.expense,true)==null}" />
                                <h:outputText value="#{document.accountName=='5' ?  document.income : trialBalanceBean.calcBalance(document.income,document.expense,true)}" class="Fright" rendered="#{document.accountName=='5' ?  document.income.doubleValue() != -2121.2121 : trialBalanceBean.calcBalance(document.income,document.expense,true)!=null}">
                                    <f:converter converterId="currencyConverter"  />
                                    <f:attribute name="currency"  value="#{sessionBean.user.lastBranch.currency}"/>
                                    <f:attribute name="type" value="currency" />
                                </h:outputText>
                            </p:column>
                            <p:column headerText="#{loc.expensebalance}" rendered="true" class="Fs14"> 
                                <h:outputText value="" rendered="#{document.accountName=='5' or trialBalanceBean.calcBalance(document.income,document.expense,false)==null}" />
                                <h:outputText value="#{trialBalanceBean.calcBalance(document.income,document.expense,false)}" class="Fright" rendered="#{document.accountName!='5' and trialBalanceBean.calcBalance(document.income,document.expense,false)!=null}">
                                    <f:converter converterId="currencyConverter"  />
                                    <f:attribute name="currency"  value="#{sessionBean.user.lastBranch.currency}"/>
                                    <f:attribute name="type" value="currency" />
                                </h:outputText>
                            </p:column>
                        </p:treeTable>
                    </p:fieldset>
                </div>

            </div>
        </h:panelGroup>
    </h:panelGroup> 


    <!--Print butonuna basınca çalışan kısım-->
    <p:panel id="printerContainer" style="display: none"  >
        <p:panelGrid id="printerPanel" >
        </p:panelGrid>
    </p:panel> 


    <script>

        function print_page() {
            var divContents = $("#printerPanel").html();
            var printWindow = window.open('', '', 'height=400,width=800');
            printWindow.document.write('<div style="text-align:center; font-weight:bold; font-family:sans-serif;">#{loc.generaltrialbalancereport}</div>');
            printWindow.document.write('<div id="printerDiv">');
            printWindow.document.write(divContents);
            printWindow.document.write('</div>');
            printWindow.document.close();
            printWindow.print();
        }

        /*Gelirler*/
        function  income(dataStr) {
            var jsondata = [];
            var list = $.parseJSON(dataStr);
            for (var i in list) {
                var data = {};
                data.label = list[i].incomeText;
                data.value = list[i].income;
                jsondata.push(data);
            }

            nv.addGraph(function () {
                var chart = nv.models.pieChart()
                        .x(function (d) {
                            return d.label;
                        })
                        .y(function (d) {
                            return d.value;
                        })
                        .showLabels(true)
                        .labelThreshold(.05)
                        .labelType("percent")
                        .donut(true)
                        .donutRatio(0.35)
                        .width(550)
                        .height(400)
                        .legendPosition("right");



                var $container = $('#pnlgrpBalanceIncome');
                width = $container.width();

                //   chart.legend.margin({top: 5, right: 0, left: -60, bottom: 0});

                d3.select('#pnlgrpBalanceIncome svg')
                        .attr("transform", "translate(" + 0 + "," + 0 + ")")
                        .datum(jsondata)
                        .transition().duration(500)
                        .call(chart);



                d3.select("#pnlgrpBalanceIncome").select(".nv-pieChart").attr("transform", "translate(" + -15 + "," + 40 + ")");

                d3.select("#pnlgrpBalanceIncome").select(".nv-legendWrap").attr("transform", "translate(" + width / 2 + "," + 0 + ")");

                nv.utils.windowResize(function () {
                    chart.legend.margin({top: 5, right: 0, left: 0, bottom: 0});
                    var $container = $('#pnlgrpBalanceIncome');
                    width = $container.width();
                    chart.update();

                    d3.select("#pnlgrpBalanceIncome").select(".nv-pieChart").attr("transform", "translate(" + -15 + "," + 40 + ")");

                    d3.select("#pnlgrpBalanceIncome").select(".nv-legendWrap").attr("transform", "translate(" + width / 2 + "," + 0 + ")");


                });

                return chart;
            });
        }

        /*Giderler*/
        function  expense(dataStr) {
            var jsondata = [];
            var list2 = $.parseJSON(dataStr);
            for (var i in list2) {
                var data = {};
                data.label = list2[i].expenseText;
                data.value = list2[i].expense;
                jsondata.push(data);
            }

            nv.addGraph(function () {
                var chart = nv.models.pieChart()
                        .x(function (d) {
                            return d.label;
                        })
                        .y(function (d) {
                            return d.value;
                        })
                        .showLabels(true)
                        .labelThreshold(.05)
                        .labelType("percent")
                        .donut(true)
                        .donutRatio(0.35)
                        .width(550)
                        .height(400)
                        .legendPosition("right");

                var $container = $('#pnlgrpBalanceExpense');
                width = $container.width();

                d3.select('#pnlgrpBalanceExpense svg')
                        .attr("transform", "translate(" + 0 + "," + 0 + ")")
                        .datum(jsondata)
                        .transition().duration(500)
                        .call(chart);

                d3.select("#pnlgrpBalanceExpense").select(".nv-pieChart").attr("transform", "translate(" + -15 + "," + 40 + ")");

                d3.select("#pnlgrpBalanceExpense").select(".nv-legendWrap").attr("transform", "translate(" + width / 2 + "," + 0 + ")");




                nv.utils.windowResize(function () {
                    var $container = $('#pnlgrpBalanceExpense');
                    width = $container.width();
                    chart.legend.margin({top: 5, right: 0, left: 0, bottom: 0});
                    chart.update();

                    d3.select("#pnlgrpBalanceExpense").select(".nv-pieChart").attr("transform", "translate(" + -15 + "," + 40 + ")");

                    d3.select("#pnlgrpBalanceExpense").select(".nv-legendWrap").attr("transform", "translate(" + width / 2 + "," + 0 + ")");


                });

                return chart;

            });
        }
    </script> 


</ui:composition>
